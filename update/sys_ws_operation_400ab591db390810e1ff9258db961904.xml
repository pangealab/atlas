<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ws_operation">
    <sys_ws_operation action="INSERT_OR_UPDATE">
        <active>true</active>
        <consumes>application/json</consumes>
        <consumes_customized>true</consumes_customized>
        <default_operation_uri/>
        <enforce_acl>cf9d01d3e73003009d6247e603f6a990</enforce_acl>
        <http_method>POST</http_method>
        <name>Services  (v2)</name>
        <operation_script><![CDATA[(function process( /*RESTAPIRequest*/ request, /*RESTAPIResponse*/ response) {

    // Constants
	var SERVICES = "cmdb_ci_service_discovered";
    var ENDPOINTS = "cmdb_ci_endpoint_http";
    var ENTRYPOINTS = "sa_m2m_service_entry_point";
    var COMMENTS = "Added by NOW CLI";

    // Input / Output
    var requestData = request.body.data;
    var responseData = {};

    // Capture Business Service Properties
    businessServiceName = requestData.name;
    businessServiceComments = requestData.comments;

    /********************************************************************************/
    /***                                Create CI's                               ***/
    /********************************************************************************/

    try {

        // Transform 1 - Items
        services1 = requestData.services;
        items1 = [];
        for (var i = 0; i < services1.length; i++) {
            service1 = services1[i];
            // Set Item
            item1 = {
                "className": SERVICES,
                "values": {
                    "name": service1.name,
                    "sys_class_name": SERVICES,
                    "comments": COMMENTS
                }
            };
            items1.push(item1);
        }

        // Set Payload 1
        payload1 = {
            items: items1
        };
        
        // DEBUG
        log("Payload 1: " + JSON.stringify(payload1));

        // Call IES with Payload 1
        result1 = JSON.parse(sn_cmdb.IdentificationEngine.createOrUpdateCI("ServiceNow", JSON.stringify(payload1)));
        
        // DEBUG
        log("Result 1: " + JSON.stringify(result1));

    } catch (e) {
        error(e.message);
    }

    /********************************************************************************/
    /***                          Create Relationships                            ***/
    /********************************************************************************/    

    try {
        
        // Create Services Lookup
        items2 = result1.items;
        var index1 = {};
        for (var j = 0; j < services1.length; j++) {
            index1[services1[j].name] = items2[j].sysId;
        }
        
        // Transform 2 - Service Relations
        relationships1 = requestData.relationships;
        service_relations1 = [];
        for (var k = 0; k < relationships1.length; k++) {
            relationship1 = relationships1[k];
            // Test for nulls
            parent = relationship1.parent === null ? parent = null : parent = index1[relationship1.parent];
            child = relationship1.child === null ? child = null : child = index1[relationship1.child];
            // Set Service Relation
            service_relation1 = {
                "parent": parent,
                "child": child
            };
            service_relations1.push(service_relation1);
        }   

        // Set Payload 2
        payload2 = {
            "name": businessServiceName,
            "comments": businessServiceComments,
            "service_relations": service_relations1
        };
        
        // DEBUG
        log("Payload 2: " + JSON.stringify(payload2));
        
        // Call CIS with Payload 2
        var createOrUpdateServiceHandler = new global.CreateOrUpdateITService();
        var result2 =  createOrUpdateServiceHandler.processJSON(JSON.stringify(payload2));
        
        // DEBUG
        log("Result 2: " + JSON.stringify(result2));
    
    } catch (e) {
        error(e.message);
    }

    /********************************************************************************/
    /***                             Create Endpoints                             ***/
    /********************************************************************************/     

    try {

        // Transform 3 - Endpoints
        services2 = requestData.services;
        items3 = [];
        for (var l = 0; l < services2.length; l++) {
            service2 = services2[l];
            var url1 = null;
            // URL Cleansing
            if (service2.protocol=="http" && service2.port=="80") {
                url1 = service2.protocol+"://"+service2.hostname;
            } else if (service2.protocol=="https" && service2.port=="443") {
                url1 = service2.protocol+"://"+service2.hostname;
            } else {
                url1 = service2.protocol+"://"+service2.hostname+":"+service2.port;
            }
            if (service2.path !== null) {
                url1 = url1 + service2.path;
            }
            // Set Item
            item2 = {
                "className": ENDPOINTS,
                "values": {
                    "name": url1,
                    "url": url1,
                    "host_name": service2.hostname,
                    "host": service2.host,
                    "sys_class_name": ENDPOINTS,
                    "sys_class_path": "/!!/!$/#J",
                    "protocol": service2.protocol,
                    "port": service2.port,
                    "comments": COMMENTS
                }
            };
            items3.push(item2);
        }

        // Set Payload 3
        payload3 = {
            items: items3
        };

        // DEBUG
        log("Payload 3: " + JSON.stringify(payload3));

        // Call IES with Payload 3
        result3 = JSON.parse(sn_cmdb.IdentificationEngine.createOrUpdateCI("ServiceNow", JSON.stringify(payload3)));

        // DEBUG
        log("Result 3: " + JSON.stringify(result3));

        // Create Endpoints Lookup
        items4 = result3.items;
        var index2 = {};
        for (var m = 0; m < services2.length; m++) {
            index2[services2[m].name] = items4[m].sysId;
        }
        
        // DEBUG
        log("Index1:" + JSON.stringify(index1));

        // DEBUG
        log("Index2:" + JSON.stringify(index2));

        for (var n = 0; n < services2.length; n++) {
            var entryPoint = new GlideRecord(ENTRYPOINTS);
            entryPoint.initialize();
            entryPoint.cmdb_ci_service = index1[services2.name];
            entryPoint.cmdb_ci_endpoint = index2[services2.name];
            var entryPointId = entryPoint.insert();
            log("EntryPointId:" + entryPointId);    
        }        

    } catch (e) {
        error(e.message);
    }

    // Create Response
    responseData.code = '200';
	responseData.type = "register_services";
    responseData.message = "Services created in ServiceNow: " + services1.length;

    return responseData;

})(request, response);

// Log INFO
function log(message) {
    gs.info(message);
}

// Log ERROR
function error(message) {
    gs.error(message);
}]]></operation_script>
        <operation_uri>/api/x_snc_labs_atlas/v2/register/services</operation_uri>
        <produces>application/json</produces>
        <produces_customized>true</produces_customized>
        <relative_path>/services</relative_path>
        <request_example>[&#13;
  {&#13;
    "name": "string",&#13;
    "host": "http://foo.com/api/v1/bar"&#13;
  }&#13;
]</request_example>
        <requires_acl_authorization>false</requires_acl_authorization>
        <requires_authentication>true</requires_authentication>
        <requires_snc_internal_role>false</requires_snc_internal_role>
        <short_description>Registers a list of Services with given input array</short_description>
        <sys_class_name>sys_ws_operation</sys_class_name>
        <sys_created_by>aangelo</sys_created_by>
        <sys_created_on>2019-12-17 16:53:46</sys_created_on>
        <sys_id>400ab591db390810e1ff9258db961904</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>Services  (v2)</sys_name>
        <sys_package display_value="labs_atlas" source="x_snc_labs_atlas">6d50983edb0508143b4a90b6db9619fc</sys_package>
        <sys_policy/>
        <sys_scope display_value="labs_atlas">6d50983edb0508143b4a90b6db9619fc</sys_scope>
        <sys_update_name>sys_ws_operation_400ab591db390810e1ff9258db961904</sys_update_name>
        <sys_updated_by>aangelo</sys_updated_by>
        <sys_updated_on>2019-12-17 16:55:52</sys_updated_on>
        <web_service_definition display_value="NOW CLI API Register Service">2b576998db1100103b4a90b6db961977</web_service_definition>
        <web_service_version display_value="v2">c00ab591db390810e1ff9258db961901</web_service_version>
    </sys_ws_operation>
</record_update>
